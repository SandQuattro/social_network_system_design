## Hi there 👋
🔭 System design социальной сети для путешественников для курса System Design

## [Travellers Social Network](https://github.com/SandQuattro/social_network_system_design)

## <img src="https://www.onetwotrip.com/ru/blog/static/images/travel-now/time-to-travel.jpg" width="500px" alt="Travel Social Network"></a>

## Бизнес-требования
- публикация постов из путешествий с фотографиями, небольшим описанием и привязкой к конкретному месту путешествия;
- оценка и комментарии постов других путешественников;
- подписка на других путешественников, чтобы следить за их активностью;
- поиск популярных мест для путешествий и просмотр постов с этих мест в виде ТОПа мест по странам и городам;
- общение с другими путешественниками в личных сообщениях;
- просмотр ленты других путешественников;
- Пользовательская база будет постепенно линейно расти и через год достигнет примерно 10 000 000 уникальных пользователей в день, после чего также будет продолжать расти. 
- Бизнес пока нацелен только на аудиторию стран СНГ (*на зарубежный рынок выходить планов нет*). 
- Будущая система должна быть очень надежной, а также, чтобы с ней было удобно взаимодействовать, используя мобильные устройства и браузер. Среднее время восстановления - не более 1 часа. Доступность - 99.95%
- Нужно будет **оценить нагрузку** на социальную сеть.

## Функциональные требования

- Отображение ленты с постами путешественников, на которых подписан
- Создание поста с прикреплением media (это может быть текстовая информация (MD), изображения, аудио(звуки природы и тд)
- Возможность добавить geoметку к посту
- Возможность поставить like посту
- Возможность добавить текстовый комментарий
- Поиск по хештегам, геометкам

## Нефункциональные требования

- Максимальный размер фото: 1Mb
- Доступность: 99.95% SLA, Постоянное резервирование БД, серверы будут расположены в нескольких географически удаленных ЦОДах для обеспечения отказоустойчивости.
- Производительность: Время ответа сервера на запрос ленты пользователя - до 2 сек
- Хранение: Обеспечить хранение media в объектном хранилище
- БД: Хранение данных пользователей, постов, геометок постов, лайков, комментариев
- Безопасность: защита данных пользователей, высокий уровень безопасности инфраструктуры
- Мониторинг: обеспечение мониторинга ресурсов инфраструктуры, потребление сервисами CPU / Memory
- UX: Минималистичный, легкий интерфейс, минимум элементов, обязательно сразу мобильная верстка frontend
- Масштабируемость компонентов при росте количества пользователей / нагрузки: обеспечение вертикальной (Железо) и горизонтальной (новые инстансы микросервисов / компонентов) масштабируемости компонентов: Если значение загрузки CPU превышает 70% или использование памяти превышает 80%, это является критическим уровнем и необходимо будет масштабировать систему.
потребность в масштабировании: если в процессе мониторинга потребления ресурсов средняя нагрузка на CPU: 75%, потребление памяти: 50 GB (78% от общей памяти) нужно рассмотреть возможность добавления дополнительных CPU, 16 GB памяти, если доступны ресурсы. Если нагрузка продолжает расти, рассмотреть масштабирование путем добавления новых серверов.

## Оценка дисков для хранения и обработки

Исходя из вышеуказанной оценки нагрузки:
- Количество пользователей в день: 10,000,000
- Количество действий каждого пользователя в день:
  - Публикации: 1
  - Комментарии: 5
  - Просмотры: 100

Рассчитываем годовое потребление емкостей системы хранения:
- Посты:
  - Годовой объем: 10 000 000 пользователей * 1 пост/день * 365 дней = 3 650 000 000 постов
  - Размер поста: 8 (bigserial) + 8 (bigint) + 1000 (content текст) + 8 (timestamp) + 8 (float) + 8 (float) = 1040 байт
  - Объем данных: 3 650 000 000 постов * 1040 байт = 3 796 000 000 KB ~ 3.8 TB
- Комментарии:
  - Годовой объем: 10 000 000 пользователей * 5 комментариев/день * 365 дней = 18 250 000 000 комментариев
  - Размер комментария: 8 (bigserial) + 8 (bigint) + 8 (bigint) + 500 (content текст) + 8 (timestamp) = 532 байта
  - Объем данных: 18 250 000 000 комментариев * 532 байт = 9 710 500 000 KB ~ 9.71 TB
- Просмотры:
  - Годовой объем: 10 000 000 пользователей * 100 просмотров/день * 365 дней = 365 000 000 000 просмотров
  - Размер просмотра: 8 (bigserial) + 8 (bigint) + 8 (bigint) + 8 (timestamp) = 32 байта
  - Объем данных: 365,000,000,000 просмотров * 100 байт = 11 680 000 000 000 KB ~ 11 TB

и так далее

Итоговый объем:
3.8 + 9.71 + 11 TB = 24,51 Tb

## Рассчитаем, сколько дисков нам потребуется отдельно по подсистемам

Параметры hdd диска:
- Объем: 32TB
- IOPS: 100
- Пропускная способность: 100 MB/s

Параметры ssd диска: 
- Объем: 100TB
- IOPS: 1,000
- Пропускная способность: 500 MB/s

Параметры ssd(nVME) диска:
- Объем: 30TB
- IOPS: 10,000
- Пропускная способность: 3 GB/s

## Оценить количество дисков можно, используя следующую формулу:

- Disks_for_capacity = capacity / disk_capacity
- Disks_for_throughput = traffic_per_second / disk_throughput
- Disks_for_iops = iops / disk_iops
- Disks = max(ceil(Disks_for_capacity), ceil(Disks_for_throughput), ceil(Disks_for_iops))

# Расчет дисков по подсистемам
## Подсистема постов:
- capacity: 3.8 TB
- traffic_per_second: 3.7 MB/s
- iops: 1904

HDD:
- Disks_for_capacity: 3.8 / 2 = 1.9 -> 2
- Disks_for_throughput: 3.7 / 100 = 0.037 -> 1
- Disks_for_iops: 1904 / 100 = 19.04 -> 20
- Disks = max(2, 1, 20) = 20

SSD (SATA):
- Disks_for_capacity: 3.8 / 100 = 0.038 -> 1
- Disks_for_throughput: 3.7 / 500 = 0.0074 -> 1
- Disks_for_iops: 1904 / 1000 = 1.904 -> 2
- Disks = max(1, 1, 2) = 2

SSD (nVME):
- Disks_for_capacity: 3.8 / 30 = 0.127 -> 1
- Disks_for_throughput: 3.7 / 3000 = 0.00123 -> 1
- Disks_for_iops: 1904 / 10000 = 0.1904 -> 1
- Disks = max(1, 1, 1) = 1

## Подсистема комментариев:
- capacity: 3.8 TB
- traffic_per_second: 3.7 MB/s
- iops: 1904

HDD:
- Disks_for_capacity: 9.71 / 2 = 4.855 -> 5
- Disks_for_throughput: 9.5 / 100 = 0.095 -> 1
- Disks_for_iops: 4856 / 100 = 48.56 -> 49
- Disks = max(5, 1, 49) = 49

SSD (SATA):
- Disks_for_capacity: 9.71 / 100 = 0.0971 -> 1
- Disks_for_throughput: 9.5 / 500 = 0.019 -> 1
- Disks_for_iops: 4856 / 1000 = 4.856 -> 5
- Disks = max(1, 1, 5) = 5

SSD (nVME):
- Disks_for_capacity: 9.71 / 30 = 0.324 -> 1
- Disks_for_throughput: 9.5 / 3000 = 0.00317 -> 1
- Disks_for_iops: 4856 / 10000 = 0.4856 -> 1
- Disks = max(1, 1, 1) = 1

## Подсистема просмотров
- capacity: 11 TB
- traffic_per_second: 10.7 MB/s
- iops: 5510

HDD:
- Disks_for_capacity: 11 / 2 = 5.5 -> 6
- Disks_for_throughput: 10.7 / 100 = 0.107 -> 1
- Disks_for_iops: 5510 / 100 = 55.1 -> 56
- Disks = max(6, 1, 56) = 56

SSD (SATA):
- Disks_for_capacity: 11 / 100 = 0.11 -> 1
- Disks_for_throughput: 10.7 / 500 = 0.0214 -> 1
- Disks_for_iops: 5510 / 1000 = 5.51 -> 6
- Disks = max(1, 1, 6) = 6

SSD (nVME):
- Disks_for_capacity: 11 / 30 = 0.367 -> 1
- Disks_for_throughput: 10.7 / 3000 = 0.00357 -> 1
- Disks_for_iops: 5510 / 10000 = 0.551 -> 1
- Disks = max(1, 1, 1) = 1

Итого:

| Подсистема	 | HDD (2TB)	 | SSD (SATA) (100TB) | SSD (nVME) (30TB) |
|-------------|------------|--------------------|-------------------|
| Посты       | 	20        | 	2                 | 1                 |
| Комментарии | 	49        | 	5                 | 1                 |
| Просмотры   | 	56        | 	6                 | 1                 | 

125 HDD дисков по 2TB для основной информации
ИЛИ
13 SSD (SATA) дисков по 100TB для основной информации
ИЛИ
3 SSD (nVME) диска по 30TB для основной информации


## Оценка количества хостов для хранения и обработки всех этих данных приложения на 1 год

Общее количество дисков для системы: 13 SSD (SATA) дисков по 100TB
Конфигурация дисков на хост: допустим, подключим 2 диска к одному хосту
Фактор репликации: 2 (Multi-Master)

Количество хостов без репликации: 13 дисков / 2 диска, подключенных к 1 хосту ~ 7
Количество хостов с учетом репликации: 7 хостов без репликации * фактор репликации 2 = 14

Итого: примерное количество хостов для хранения и обработки данных с учетом репликации - 14

Отдельно стоит рассмотреть вариант с загрузкой медиа файлов.
Из нефункциональных требований мы помним, что максимальный размер фото: 1Mb и DAU : 10 000 000
Допустим, каждый пользователь:
- загружает 1 изображение в день
- просматривает 10 изображений в день

Общий объем данных:
- Загрузка: 10 000 000 пользователей * 1 файл = 10 000 000 файлов * 1 MB = 10 000 000 MB = 10TB
- Просмотры пользователем: в 10 раз больше = 100TB
- Суточный RPS по media 1 пользователем: 10TB загрузка + 100TB просмотр = 110TB в день
- 110TB / 86400 секунд в 24ч = 1270 Mb/sec = 1.27Gb/s
- Максимум пропускной способности ssd диска = 500 - 1270 Mb/sec / 500 ~ 2.54 = потребуется 3 SSD диска
- Дисков для хранения данных 13 + 3 диска для обеспечения пропускной способности медиа файлов = 16
- Дисков на хост также 2, 16 / 2 = 8 хостов без репликации * фактор репликации 2 = 16

Итого: Учитывая нагрузку по работе с изображениями, количество хостов увеличится до 16, так как
активная работа с media увеличивает требования к пропускной способности системы